<!--/*@thymesVar id="subscriptions" type="java.util.List<me.femrek.viewcounter.dto.SubscriptionDTO>"*/-->
<div th:fragment="subscriptions" class="d-flex justify-content-center mt-5">
    <div class="card-container w-100">
        <h2 class="title-primary mb-4 text-center">Subscriptions</h2>

        <div class="row g-3">
            <div th:if="${subscriptions.isEmpty()}">

            </div>
            <div class="col-12" th:each="subscription : ${subscriptions}">
                <form th:action="@{/subscriptions/{id}(id=${subscription.id})}" method="post"
                      class="card-body d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2">

                    <input type="hidden" name="_method" value="patch"/>
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                    <div class="w-100">
                        <div class="d-flex align-items-center gap-2 mb-1 flex-wrap">
                            <h5 class="card-title mb-1 d-flex align-items-center gap-2">
                                <!--suppress HtmlFormInputWithoutLabel -->
                                <input th:id="'name-' + ${subscription.getId()}"
                                       class="editable-name-input" th:value="${subscription.getName()}"
                                       contenteditable="false" th:name="name" hidden />
                                <span th:id="'span-name-' + ${subscription.getId()}"
                                      class="editable-name"
                                      contenteditable="false"
                                      th:text="${subscription.name}">
                                </span>
                                <button type="button"
                                        class="btn btn-sm btn-outline-secondary edit-icon"
                                        th:attr="data-target='name-' + ${subscription.getId()}">
                                    ‚úèÔ∏è Edit
                                </button>
                                <button type="submit"
                                        class="btn btn-sm btn-success save-button d-none"
                                        th:attr="data-target='name-' + ${subscription.getId()}">
                                    üíæ Save
                                </button>
                            </h5>
                        </div>
                        <p class="card-text text-muted mb-0">
                            Views: <span th:text="${subscription.getCount()}">0</span>
                        </p>
                    </div>

                    <button type="button"
                            class="btn btn-outline-primary btn-sm btn-rounded mt-2 mt-md-0 copy-btn"
                            th:attr="data-url=${subscription.getSvgEndpoint()}">
                        üìã Copy Badge URL
                    </button>
                    <button type="button"
                            class="btn btn-outline-primary btn-sm btn-rounded mt-2 mt-md-0 copy-btn"
                            th:attr="data-url=${subscription.getRestEndpoint()}">
                        üìã Copy Rest URL
                    </button>
                </form>
            </div>

            <div class="col-12">
                <div class="card-body text-center">
                    <form th:action="@{/subscriptions}" method="post">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                        <div class="row g-2 align-items-center justify-content-center">
                            <div class="col-auto">
                                <button type="submit" class="btn btn-success btn-rounded">
                                    + Add New Subscription
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.copy-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const path = button.getAttribute('data-url');
                    const fullUrl = window.location.origin + path;
                    const innerText = button.innerText;

                    navigator.clipboard.writeText(fullUrl).then(() => {
                        button.textContent = "‚úÖ Copied!";
                        setTimeout(() => {
                            button.textContent = innerText;
                        }, 1500);
                    }).catch(err => {
                        console.error('Failed to copy URL: ', err);
                        alert("Failed to copy URL.");
                    });
                });
            });

            document.querySelectorAll('.editable-name').forEach(span => {
                span.addEventListener('keydown', (event) => {
                    // handle enter press
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        const editBtn = span.nextElementSibling;
                        const saveBtn = editBtn.nextElementSibling;
                        saveBtn.click();
                    }
                });
            });

            document.querySelectorAll('.edit-icon').forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetId = btn.getAttribute('data-target');
                    const spanField = document.getElementById('span-' + targetId);
                    const saveBtn = btn.nextElementSibling;

                    spanField.setAttribute('contenteditable', 'true');
                    spanField.focus();
                    const range = document.createRange();
                    range.selectNodeContents(spanField);
                    const selection = window.getSelection();

                    selection.removeAllRanges();
                    selection.addRange(range);

                    btn.classList.add('d-none');
                    saveBtn.classList.remove('d-none');
                });
            });

            document.querySelectorAll('.save-button').forEach(saveBtn => {
                saveBtn.addEventListener('click', () => {
                    const targetId = saveBtn.getAttribute('data-target');
                    const field = document.getElementById(targetId);
                    const spanField = document.getElementById('span-' + targetId);
                    const editBtn = saveBtn.previousElementSibling;

                    spanField.setAttribute('contenteditable', 'false');
                    saveBtn.classList.add('d-none');
                    editBtn.classList.remove('d-none');

                    spanField.innerText = spanField.innerText.trim();
                    field.value = spanField.innerText;
                });
            });
        });
    </script>
</div>
